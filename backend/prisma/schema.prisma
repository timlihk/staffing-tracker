generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                                                             Int                             @id @default(autoincrement())
  username                                                       String                          @unique
  email                                                          String                          @unique
  passwordHash                                                   String                          @map("password_hash")
  role                                                           String                          @default("viewer")
  staffId                                                        Int?                            @map("staff_id")
  lastLogin                                                      DateTime?                       @map("last_login")
  createdAt                                                      DateTime                        @default(now()) @map("created_at")
  mustResetPassword                                              Boolean                         @default(false) @map("must_reset_password")
  lastActivity                                                   DateTime?                       @map("last_activity")
  activityLogs                                                   ActivityLog[]
  billing_access_settings                                        billing_access_settings[]
  billing_bc_attorney_staff_map                                  billing_bc_attorney_staff_map[]
  billing_milestone_billing_milestone_invoice_sent_byTousers     billing_milestone[]             @relation("billing_milestone_invoice_sent_byTousers")
  billing_milestone_billing_milestone_payment_received_byTousers billing_milestone[]             @relation("billing_milestone_payment_received_byTousers")
  billing_staffing_project_link                                  billing_staffing_project_link[]
  billing_milestone_trigger_queue                                billing_milestone_trigger_queue[]
  projectEventsCreated                                           project_event[]                  @relation("ProjectEventCreatedBy")
  projectChanges                                                 ProjectChangeHistory[]          @relation("ProjectChanges")
  projectConfirmations                                           Project[]                       @relation("ProjectConfirmations")
  projectLifecycleChanges                                        Project[]                       @relation("ProjectLifecycleChanges")
  staffChanges                                                   StaffChangeHistory[]            @relation("StaffChanges")
  refreshTokens                                                  RefreshToken[]
  staff                                                          Staff?                          @relation(fields: [staffId], references: [id])

  @@index([role])
  @@index([lastActivity])
  @@map("users")
}

model Staff {
  id                                Int                                 @id @default(autoincrement())
  name                              String
  email                             String?                             @unique
  position                          String
  department                        String?
  status                            String                              @default("active")
  notes                             String?
  createdAt                         DateTime                            @default(now()) @map("created_at")
  updatedAt                         DateTime                            @updatedAt @map("updated_at")
  billing_bc_attorney_staff_map     billing_bc_attorney_staff_map[]
  billing_project_bc_attorney       billing_project_bc_attorney[]
  billing_action_item               billing_action_item[]
  assignments                       ProjectAssignment[]
  bcAttorneys                       ProjectBcAttorney[]
  changeHistory                     StaffChangeHistory[]                @relation("StaffChangeHistory")
  users                             User[]

  @@index([position])
  @@index([status])
  @@index([department])
  @@map("staff")
}

model Project {
  id                            Int                             @id @default(autoincrement())
  name                          String                          @unique
  category                      String
  status                        String
  priority                      String?
  notes                         String?
  createdAt                     DateTime                        @default(now()) @map("created_at")
  updatedAt                     DateTime                        @updatedAt @map("updated_at")
  elStatus                      String?                         @map("el_status")
  bcAttorney                    String?                         @map("bc_attorney")  // Legacy field - keep for migration
  cmNumber                      String?                         @unique @map("cm_number") // Primary C/M number linked to billing
  timetable                     Timetable?
  filingDate                    DateTime?                       @map("filing_date")
  listingDate                   DateTime?                       @map("listing_date")
  sector                        String?
  side                          String?
  lastConfirmedAt               DateTime?                       @map("last_confirmed_at")
  lastConfirmedBy               Int?                            @map("last_confirmed_by")
  lifecycleStage                String?                         @map("lifecycle_stage")
  lifecycleStageChangedAt       DateTime?                       @map("lifecycle_stage_changed_at")
  lifecycleStageChangedBy       Int?                            @map("lifecycle_stage_changed_by")
  stageVersion                  Int                             @default(0) @map("stage_version")
  billing_staffing_project_link billing_staffing_project_link[]
  billing_milestone_trigger_queue billing_milestone_trigger_queue[]
  projectEvents                 project_event[]
  assignments                   ProjectAssignment[]
  bcAttorneys                   ProjectBcAttorney[]
  changeHistory                 ProjectChangeHistory[]          @relation("ProjectChangeHistory")
  confirmedBy                   User?                           @relation("ProjectConfirmations", fields: [lastConfirmedBy], references: [id])
  lifecycleChangedBy            User?                           @relation("ProjectLifecycleChanges", fields: [lifecycleStageChangedBy], references: [id])

  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([timetable])
  @@index([lastConfirmedAt])
  @@index([cmNumber])
  @@index([lifecycleStage])
  @@index([stageVersion])
  @@map("projects")
}

model project_event {
  id                    Int       @id @default(autoincrement())
  project_id            Int       @map("project_id")
  event_type            String    @map("event_type")
  event_key             String?   @unique @map("event_key")
  occurred_at           DateTime  @default(now()) @map("occurred_at")
  status_from           String?   @map("status_from")
  status_to             String?   @map("status_to")
  lifecycle_stage_from  String?   @map("lifecycle_stage_from")
  lifecycle_stage_to    String?   @map("lifecycle_stage_to")
  source                String    @default("system")
  payload               Json?
  created_by            Int?      @map("created_by")
  created_at            DateTime  @default(now()) @map("created_at")
  project               Project   @relation(fields: [project_id], references: [id], onDelete: Cascade)
  createdBy             User?     @relation("ProjectEventCreatedBy", fields: [created_by], references: [id], onDelete: SetNull)
  billing_milestone_trigger_queue billing_milestone_trigger_queue[]

  @@index([project_id], map: "idx_project_event_project")
  @@index([event_type], map: "idx_project_event_type")
  @@index([occurred_at], map: "idx_project_event_occurred")
  @@index([project_id, occurred_at], map: "idx_project_event_project_occurred")
  @@map("project_event")
}

model ProjectAssignment {
  id           Int       @id @default(autoincrement())
  projectId    Int       @map("project_id")
  staffId      Int       @map("staff_id")
  jurisdiction String?
  startDate    DateTime? @map("start_date")
  endDate      DateTime? @map("end_date")
  notes        String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  project      Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  staff        Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([projectId, staffId, jurisdiction])
  @@index([projectId])
  @@index([staffId])
  @@map("project_assignments")
}

model ProjectBcAttorney {
  id        Int      @id @default(autoincrement())
  projectId Int      @map("project_id")
  staffId   Int      @map("staff_id")
  createdAt DateTime @default(now()) @map("created_at")
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  staff     Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([projectId, staffId])
  @@index([projectId])
  @@index([staffId])
  @@map("project_bc_attorneys")
}

model ProjectChangeHistory {
  id         Int      @id @default(autoincrement())
  projectId  Int      @map("project_id")
  fieldName  String   @map("field_name")
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  changeType String   @map("change_type")
  changedBy  Int?     @map("changed_by")
  changedAt  DateTime @default(now()) @map("changed_at")
  user       User?    @relation("ProjectChanges", fields: [changedBy], references: [id])
  project    Project  @relation("ProjectChangeHistory", fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([changedAt(sort: Desc)])
  @@index([projectId, changedAt(sort: Desc)])
  @@map("project_change_history")
}

model StaffChangeHistory {
  id         Int      @id @default(autoincrement())
  staffId    Int      @map("staff_id")
  fieldName  String   @map("field_name")
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  changeType String   @map("change_type")
  changedBy  Int?     @map("changed_by")
  changedAt  DateTime @default(now()) @map("changed_at")
  user       User?    @relation("StaffChanges", fields: [changedBy], references: [id])
  staff      Staff    @relation("StaffChangeHistory", fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([changedAt(sort: Desc)])
  @@map("staff_change_history")
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int?     @map("user_id")
  actionType  String   @map("action_type")
  entityType  String   @map("entity_type")
  entityId    Int?     @map("entity_id")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@index([entityType])
  @@index([entityId])
  @@index([entityType, entityId])
  @@map("activity_log")
}

model EmailSettings {
  id                        Int      @id @default(autoincrement())
  emailNotificationsEnabled Boolean  @default(true) @map("email_notifications_enabled")
  notifyPartner             Boolean  @default(true) @map("notify_partner")
  notifyAssociate           Boolean  @default(true) @map("notify_associate")
  notifyJuniorFlic          Boolean  @default(true) @map("notify_junior_flic")
  notifySeniorFlic          Boolean  @default(true) @map("notify_senior_flic")
  notifyIntern              Boolean  @default(true) @map("notify_intern")
  notifyBCWorkingAttorney   Boolean  @default(true) @map("notify_bc_working_attorney")
  updatedAt                 DateTime @updatedAt @map("updated_at")
  updatedBy                 Int?     @map("updated_by")

  @@map("email_settings")
}

model AppSettings {
  id                  Int      @id @default(autoincrement())
  enableDataExport    Boolean  @default(false) @map("enable_data_export")
  billingEaUserId     Int?     @map("billing_ea_user_id") // User ID of the EA responsible for billing milestone confirmations
  billingTriggerEnabled Boolean @default(true) @map("billing_trigger_enabled") // Enable/disable billing milestone trigger system
  updatedAt           DateTime @updatedAt @map("updated_at")
  updatedBy           Int?     @map("updated_by")

  @@map("app_settings")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model billing_access_settings {
  id                     Int       @id @default(autoincrement())
  billing_module_enabled Boolean?  @default(false)
  access_level           String?   @default("admin_only")
  updated_by             Int?
  updated_at             DateTime? @default(now()) @db.Timestamptz(6)
  users                  User?     @relation(fields: [updated_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model billing_bc_attorney_staff_map {
  map_id                Int       @id @default(autoincrement())
  billing_attorney_name String    @unique
  staff_id              Int?
  match_confidence      Decimal?  @db.Decimal(3, 2)
  is_auto_mapped        Boolean?  @default(false)
  manually_confirmed_by Int?
  confirmed_at          DateTime? @db.Timestamptz(6)
  notes                 String?
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  users                 User?     @relation(fields: [manually_confirmed_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  staff                 Staff?    @relation(fields: [staff_id], references: [id], onUpdate: NoAction)

  @@index([billing_attorney_name], map: "idx_billing_bc_name")
  @@index([staff_id], map: "idx_billing_bc_staff")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model billing_engagement {
  engagement_id           BigInt                    @id @default(autoincrement())
  project_id              BigInt
  cm_id                   BigInt
  engagement_code         String?
  engagement_title        String?
  name                    String?
  start_date              DateTime?                 @db.Date
  end_date                DateTime?                 @db.Date
  created_at              DateTime                  @default(now()) @db.Timestamptz(6)
  updated_at              DateTime                  @default(now()) @db.Timestamptz(6)
  billing_project_cm_no   billing_project_cm_no     @relation(fields: [cm_id], references: [cm_id], onDelete: NoAction, onUpdate: NoAction)
  billing_project         billing_project           @relation(fields: [project_id], references: [project_id], onDelete: Cascade, onUpdate: NoAction)
  billing_event           billing_event[]
  billing_fee_arrangement billing_fee_arrangement[]
  billing_finance_comment billing_finance_comment[]
  billing_invoice         billing_invoice[]
  billing_milestone       billing_milestone[]

  @@unique([cm_id, engagement_code], map: "billing_engagement_cm_engagement_unique")
  @@index([cm_id], map: "idx_billing_engagement_cm")
  @@index([project_id], map: "idx_billing_engagement_project")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model billing_event {
  event_id                        BigInt                           @id @default(autoincrement())
  engagement_id                   BigInt
  invoice_id                      BigInt?
  milestone_id                    BigInt?
  source_id                       BigInt?
  event_type                      String
  event_date                      DateTime                         @db.Date
  amount_value                    Decimal?                         @db.Decimal(18, 2)
  amount_currency                 String?
  source                          String?
  notes                           String?
  created_at                      DateTime                         @default(now()) @db.Timestamptz(6)
  billing_engagement              billing_engagement               @relation(fields: [engagement_id], references: [engagement_id], onDelete: Cascade, onUpdate: NoAction)
  billing_invoice                 billing_invoice?                 @relation(fields: [invoice_id], references: [invoice_id], onDelete: NoAction, onUpdate: NoAction)
  billing_milestone               billing_milestone?               @relation(fields: [milestone_id], references: [milestone_id], onDelete: NoAction, onUpdate: NoAction)
  billing_source_transactions_raw billing_source_transactions_raw? @relation(fields: [source_id], references: [source_id], onDelete: NoAction, onUpdate: NoAction)

  @@index([engagement_id, event_date], map: "idx_billing_event_engagement_date")
  @@index([event_type], map: "idx_billing_event_type")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model billing_fee_arrangement {
  fee_id                          BigInt                           @id @default(autoincrement())
  engagement_id                   BigInt
  source_id                       BigInt?
  raw_text                        String
  original_markup_html            String?
  parsed_json                     Json?
  lsd_date                        DateTime?                        @db.Date
  lsd_raw                         String?
  parser_version                  String?
  parsed_at                       DateTime?                        @db.Timestamptz(6)
  created_at                      DateTime                         @default(now()) @db.Timestamptz(6)
  updated_at                      DateTime                         @default(now()) @db.Timestamptz(6)
  bonus_description               String?
  bonus_amount_usd                Decimal?                         @db.Decimal(18, 2)
  bonus_amount_cny                Decimal?                         @db.Decimal(18, 2)
  billing_engagement              billing_engagement               @relation(fields: [engagement_id], references: [engagement_id], onDelete: Cascade, onUpdate: NoAction)
  billing_source_transactions_raw billing_source_transactions_raw? @relation(fields: [source_id], references: [source_id], onDelete: NoAction, onUpdate: NoAction)
  billing_milestone               billing_milestone[]

  @@index([engagement_id], map: "idx_billing_fee_engagement")
  @@index([lsd_date], map: "idx_billing_fee_lsd")
}

model billing_finance_comment {
  comment_id                      BigInt                           @id @default(autoincrement())
  engagement_id                   BigInt
  source_id                       BigInt?
  comment_raw                     String
  fingerprint_hash                String
  markup_html_raw                 String?
  extracted_json                  Json?
  parsed_at                       DateTime?                        @db.Timestamptz(6)
  created_at                      DateTime                         @default(now()) @db.Timestamptz(6)
  billing_engagement              billing_engagement               @relation(fields: [engagement_id], references: [engagement_id], onDelete: Cascade, onUpdate: NoAction)
  billing_source_transactions_raw billing_source_transactions_raw? @relation(fields: [source_id], references: [source_id], onDelete: NoAction, onUpdate: NoAction)

  @@unique([engagement_id, fingerprint_hash])
  @@index([engagement_id], map: "idx_billing_finance_engagement")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model billing_invoice {
  invoice_id         BigInt             @id @default(autoincrement())
  engagement_id      BigInt
  milestone_id       BigInt?
  invoice_no         String?
  amount_value       Decimal            @db.Decimal(18, 2)
  amount_currency    String             @default("USD")
  issued_date        DateTime?          @db.Date
  due_date           DateTime?          @db.Date
  paid_date          DateTime?          @db.Date
  status             String?            @default("draft")
  notes              String?
  created_at         DateTime           @default(now()) @db.Timestamptz(6)
  updated_at         DateTime           @default(now()) @db.Timestamptz(6)
  billing_event      billing_event[]
  billing_engagement billing_engagement @relation(fields: [engagement_id], references: [engagement_id], onDelete: Cascade, onUpdate: NoAction)
  billing_milestone  billing_milestone? @relation(fields: [milestone_id], references: [milestone_id], onDelete: NoAction, onUpdate: NoAction)
  billing_payment    billing_payment[]

  @@unique([engagement_id, invoice_no])
  @@index([engagement_id, issued_date, paid_date], map: "idx_billing_invoice_dates")
  @@index([engagement_id], map: "idx_billing_invoice_engagement")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model billing_milestone {
  milestone_id                                       BigInt                   @id @default(autoincrement())
  fee_id                                             BigInt?
  ordinal                                            String
  title                                              String?
  description                                        String?
  trigger_type                                       String?
  trigger_text                                       String?
  amount_value                                       Decimal?                 @db.Decimal(18, 2)
  amount_currency                                    String?
  is_percent                                         Boolean                  @default(false)
  percent_value                                      Decimal?                 @db.Decimal(6, 2)
  due_date                                           DateTime?                @db.Date
  due_days_relative                                  Int?
  completed                                          Boolean                  @default(false)
  completion_source                                  String?
  completion_date                                    DateTime?                @db.Date
  raw_fragment                                       String
  sort_order                                         Int?
  created_at                                         DateTime                 @default(now()) @db.Timestamptz(6)
  updated_at                                         DateTime                 @default(now()) @db.Timestamptz(6)
  engagement_id                                      BigInt
  invoice_sent_date                                  DateTime?                @db.Date
  payment_received_date                              DateTime?                @db.Date
  invoice_sent_by                                    Int?
  payment_received_by                                Int?
  notes                                              String?
  last_reminder_sent_at                              DateTime?                @db.Timestamptz(6)
  reminder_frequency                                 String?                  @default("weekly") // e.g., "daily", "weekly", "monthly", "none"
  reminder_enabled                                   Boolean                  @default(true)
  billing_event                                      billing_event[]
  billing_invoice                                    billing_invoice[]
  billing_engagement                                 billing_engagement       @relation(fields: [engagement_id], references: [engagement_id], onDelete: Cascade, onUpdate: NoAction)
  billing_fee_arrangement                            billing_fee_arrangement? @relation(fields: [fee_id], references: [fee_id], onDelete: Cascade, onUpdate: NoAction)
  users_billing_milestone_invoice_sent_byTousers     User?                    @relation("billing_milestone_invoice_sent_byTousers", fields: [invoice_sent_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_billing_milestone_payment_received_byTousers User?                    @relation("billing_milestone_payment_received_byTousers", fields: [payment_received_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  billing_milestone_trigger_queue billing_milestone_trigger_queue[]
  billing_action_item billing_action_item[]
  billing_milestone_trigger_rule billing_milestone_trigger_rule[]

  @@unique([engagement_id, ordinal], map: "billing_milestone_engagement_ordinal_unique")
  @@index([invoice_sent_date, payment_received_date], map: "idx_billing_milestone_billing_status")
  @@index([completed], map: "idx_billing_milestone_completed")
  @@index([engagement_id], map: "idx_billing_milestone_engagement")
  @@index([engagement_id, sort_order], map: "idx_billing_milestone_engagement_sort")
  @@index([fee_id, sort_order], map: "idx_billing_milestone_fee_sort")
  @@index([last_reminder_sent_at], map: "idx_billing_milestone_last_reminder_sent")
}

model billing_milestone_trigger_rule {
  id                      Int       @id @default(autoincrement())
  milestone_id            BigInt    @map("milestone_id")
  trigger_mode            String    @default("manual") @map("trigger_mode") // common, bespoke, manual, legacy_text
  anchor_event_type       String?   @map("anchor_event_type")
  requires_invoice_issued Boolean   @default(false) @map("requires_invoice_issued")
  requires_payment_received Boolean @default(false) @map("requires_payment_received")
  due_in_business_days    Int?      @map("due_in_business_days")
  fallback_due_date       DateTime? @db.Date @map("fallback_due_date")
  recurrence              String?   @default("none")
  auto_confirm            Boolean   @default(false) @map("auto_confirm")
  manual_confirm_required Boolean   @default(true) @map("manual_confirm_required")
  condition_json          Json?     @map("condition_json")
  confidence              Decimal?  @db.Decimal(3, 2)
  rule_version            Int       @default(1) @map("rule_version")
  created_at              DateTime  @default(now()) @map("created_at")
  updated_at              DateTime  @default(now()) @map("updated_at")
  milestone               billing_milestone @relation(fields: [milestone_id], references: [milestone_id], onDelete: Cascade)
  billing_milestone_trigger_queue billing_milestone_trigger_queue[]

  @@index([milestone_id], map: "idx_trigger_rule_milestone")
  @@index([trigger_mode], map: "idx_trigger_rule_mode")
  @@index([anchor_event_type], map: "idx_trigger_rule_anchor")
  @@index([auto_confirm], map: "idx_trigger_rule_auto_confirm")
  @@map("billing_milestone_trigger_rule")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model billing_payment {
  payment_id           BigInt          @id @default(autoincrement())
  invoice_id           BigInt
  paid_amount_value    Decimal         @db.Decimal(18, 2)
  paid_amount_currency String          @default("USD")
  paid_date            DateTime?       @db.Date
  method               String?
  receipt_ref          String?
  created_at           DateTime        @default(now()) @db.Timestamptz(6)
  billing_invoice      billing_invoice @relation(fields: [invoice_id], references: [invoice_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([paid_date], map: "idx_billing_payment_date")
  @@index([invoice_id], map: "idx_billing_payment_invoice")
}

model billing_project {
  project_id                    BigInt                          @id @default(autoincrement())
  project_name                  String
  client_name                   String?
  attorney_in_charge            String?                         // Legacy field - keep for reference
  sca                           String?
  base_currency                 String                          @default("USD")
  created_at                    DateTime                        @default(now()) @db.Timestamptz(6)
  updated_at                    DateTime                        @default(now()) @db.Timestamptz(6)
  billing_engagement            billing_engagement[]
  billing_project_bc_attorney   billing_project_bc_attorney[]
  billing_project_cm_no         billing_project_cm_no[]
  billing_staffing_project_link billing_staffing_project_link[]

  @@index([attorney_in_charge], map: "idx_billing_project_attorney")
  @@index([project_name], map: "idx_billing_project_name")
}

model billing_project_bc_attorney {
  id                 Int             @id @default(autoincrement())
  billing_project_id BigInt          @map("billing_project_id")
  staff_id           Int             @map("staff_id")
  role               String?         @default("bc_attorney")
  created_at         DateTime        @default(now()) @db.Timestamptz(6)
  billing_project    billing_project @relation(fields: [billing_project_id], references: [project_id], onDelete: Cascade, onUpdate: NoAction)
  staff              Staff           @relation(fields: [staff_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([billing_project_id, staff_id])
  @@index([billing_project_id], map: "idx_billing_project_bc_attorney_project")
  @@index([staff_id], map: "idx_billing_project_bc_attorney_staff")
  @@map("billing_project_bc_attorneys")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model billing_project_cm_no {
  cm_id                  BigInt               @id @default(autoincrement())
  project_id             BigInt
  cm_no                  String
  is_primary             Boolean              @default(false)
  open_date              DateTime?            @db.Date
  closed_date            DateTime?            @db.Date
  status                 String?              @default("active")
  billing_to_date_usd    Decimal?             @default(0) @db.Decimal(18, 2)
  billing_to_date_cny    Decimal?             @default(0) @db.Decimal(18, 2)
  collected_to_date_usd  Decimal?             @default(0) @db.Decimal(18, 2)
  collected_to_date_cny  Decimal?             @default(0) @db.Decimal(18, 2)
  ubt_usd                Decimal?             @default(0) @db.Decimal(18, 2)
  ubt_cny                Decimal?             @default(0) @db.Decimal(18, 2)
  billing_credit_usd     Decimal?             @default(0) @db.Decimal(18, 2)
  billing_credit_cny     Decimal?             @default(0) @db.Decimal(18, 2)
  financials_updated_at  DateTime?            @db.Timestamptz(6)
  financials_updated_by  Int?
  billing_engagement     billing_engagement[]
  billing_project        billing_project      @relation(fields: [project_id], references: [project_id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([project_id, cm_no])
  @@index([cm_no], map: "idx_billing_cm_no")
  @@index([project_id], map: "idx_billing_cm_project")
  @@index([status], map: "idx_billing_cm_status")
}

model billing_source_transactions_raw {
  source_id               BigInt                    @id @default(autoincrement())
  import_batch_id         String?
  source_row_num          Int?
  full_row_text           String
  project_name_raw        String?
  cm_no_raw               String?
  fee_arrangement_raw     String?
  finance_comment_raw     String?
  remarks_raw             String?
  row_hash                String                    @unique
  loaded_at               DateTime                  @default(now()) @db.Timestamptz(6)
  billing_event           billing_event[]
  billing_fee_arrangement billing_fee_arrangement[]
  billing_finance_comment billing_finance_comment[]

  @@index([import_batch_id], map: "idx_billing_source_batch")
}

model billing_staffing_project_link {
  link_id             Int              @id @default(autoincrement())
  billing_project_id  BigInt?
  staffing_project_id Int?
  linked_by           Int?
  linked_at           DateTime?        @default(now()) @db.Timestamptz(6)
  auto_match_score    Decimal?         @db.Decimal(3, 2)
  notes               String?
  billing_project     billing_project? @relation(fields: [billing_project_id], references: [project_id], onDelete: Cascade, onUpdate: NoAction)
  users               User?            @relation(fields: [linked_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  projects            Project?         @relation(fields: [staffing_project_id], references: [id], onUpdate: NoAction)

  @@unique([billing_project_id, staffing_project_id])
  @@index([billing_project_id], map: "idx_billing_project_link")
  @@index([staffing_project_id], map: "idx_staffing_project_link")
}

enum Timetable {
  PRE_A1
  A1
  HEARING
  LISTING
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model billing_milestone_trigger_queue {
  id                    Int       @id @default(autoincrement())
  milestone_id          BigInt    @map("milestone_id")
  staffing_project_id   Int       @map("staffing_project_id")
  old_status            String    @map("old_status")
  new_status            String    @map("new_status")
  match_confidence      Decimal   @db.Decimal(3, 2) @map("match_confidence")
  trigger_reason        String?   @map("trigger_reason")
  status                String    @default("pending") // pending, confirmed, rejected
  confirmed_by          Int?      @map("confirmed_by")
  confirmed_at          DateTime? @map("confirmed_at")
  action_taken          String?   @map("action_taken") // invoice_issued, payment_followup, etc.
  project_event_id      Int?      @map("project_event_id")
  rule_id               Int?      @map("rule_id")
  match_method          String?   @map("match_method") // common_rule, bespoke_rule, legacy_text
  created_at            DateTime  @default(now()) @map("created_at")

  // Relations
  milestone             billing_milestone @relation(fields: [milestone_id], references: [milestone_id], onDelete: Cascade)
  project               Project           @relation(fields: [staffing_project_id], references: [id], onDelete: Cascade)
  confirmedBy           User?            @relation(fields: [confirmed_by], references: [id], onDelete: SetNull)
  projectEvent          project_event?   @relation(fields: [project_event_id], references: [id], onDelete: SetNull)
  rule                  billing_milestone_trigger_rule? @relation(fields: [rule_id], references: [id], onDelete: SetNull)
  billing_action_item  billing_action_item[]

  // Unique constraint to prevent duplicate pending triggers
  @@unique([milestone_id, new_status, status], map: "idx_trigger_unique_pending")
  @@unique([milestone_id, project_event_id], map: "idx_trigger_unique_event")
  @@index([status], map: "idx_trigger_queue_status")
  @@index([staffing_project_id], map: "idx_trigger_queue_project")
  @@index([project_event_id], map: "idx_trigger_queue_event")
  @@index([rule_id], map: "idx_trigger_queue_rule")
  @@index([created_at], map: "idx_trigger_queue_created")
  @@map("billing_milestone_trigger_queue")
}

model billing_action_item {
  id                    Int       @id @default(autoincrement())
  trigger_queue_id      Int?      @map("trigger_queue_id")
  milestone_id          BigInt    @map("milestone_id")
  action_type           String    @map("action_type") // issue_invoice, follow_up_payment, etc.
  description           String
  due_date              DateTime? @map("due_date")
  assigned_to           Int?      @map("assigned_to")
  status                String    @default("pending") // pending, completed, cancelled
  completed_at          DateTime? @map("completed_at")
  created_at            DateTime  @default(now()) @map("created_at")

  // Relations
  trigger_queue         billing_milestone_trigger_queue? @relation(fields: [trigger_queue_id], references: [id], onDelete: SetNull)
  milestone             billing_milestone @relation(fields: [milestone_id], references: [milestone_id], onDelete: Cascade)
  assignedTo           Staff?            @relation(fields: [assigned_to], references: [id], onDelete: SetNull)

  @@index([status], map: "idx_action_item_status")
  @@index([assigned_to], map: "idx_action_item_assigned")
  @@map("billing_action_item")
}
